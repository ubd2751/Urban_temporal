---
title: "Plant"
author: "ubd2751"
date: "2023-04-04"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  root.dir = "/temp")
```

# Package

```{r package, include=FALSE}
pacman::p_load(
  tidyverse,  # data management
  rtry, austraits,  # trait
  lme4, lmerTest, broom, multcomp, #GLM
  ggeffects, patchwork, ggsci,  # ggplot
  vegan # composition
  )

#remotes::install_github("traitecoevo/austraits", dependencies = TRUE, upgrade = "ask")
```

```{r include=FALSE}
# For read_csv
options(
  readr.num_columns = 0L,
  readr.show_col_types = FALSE,
  readr.show_progress = FALSE
)
```

# Data frame for trait



## Trait (leaf, seed)

### Try

Plant height

```{r try plant height}
# Load data
try_height1 <- rtry_import("data/try/try_height1.txt", showOverview = FALSE)
try_height2 <- rtry_import("data/try/try_height2.txt", showOverview = FALSE)

# data frame
try_height <-
  bind_rows(try_height1, try_height2) %>% 
  dplyr::filter(
    str_detect(TraitName, "height") & 
      !is.na(OrigValueStr) &
      !str_detect(OriglName, "lower")
    ) %>% 
  dplyr::mutate(
    OrigValueStr = as.numeric(OrigValueStr),
    height = case_when(
      str_detect(OrigUnitStr, pattern = "cm") ~ OrigValueStr*10,
      OrigUnitStr == "Cm"   ~ OrigValueStr * 10,
      OrigUnitStr == "feet" ~ OrigValueStr * 304.8,
      OrigUnitStr == "m"    ~ OrigValueStr * 1000,
      OrigUnitStr == "mm"   ~ OrigValueStr
      )
    ) %>% 
  dplyr::filter(!is.na(height) & !str_detect(TraitName, "generative")) %>% 
  dplyr::group_by(AccSpeciesName) %>% 
  dplyr::summarise(height = mean(height)) 
```

Seed mass & Life form

```{r try seed life}
# Load data
try_seed1   <- rtry_import("data/try/try_seed1.txt", showOverview = FALSE)
try_seed2   <- rtry_import("data/try/try_seed2.txt", showOverview = FALSE)


# data frame for seed mass
try_seed <-
  bind_rows(try_seed1, try_seed2) %>% 
  dplyr::filter(str_detect(TraitName, "Seed")) %>% 
  filter(!is.na(StdValue)) %>% 
  group_by(AccSpeciesName) %>% 
  summarise(seed_mass = mean(StdValue))
```

Specific leaf area

```{r}
try_sla1    <- rtry_import("data/try/try_SLA1.txt", showOverview = FALSE)
try_sla2    <- rtry_import("data/try/try_SLA2.txt", showOverview = FALSE)

# data frame 
try_sla <-
  bind_rows(try_sla1, try_sla1) %>% 
  dplyr::filter(str_detect(TraitName, "area")) %>% 
  filter(!is.na(StdValue)) %>% 
  group_by(AccSpeciesName) %>% 
  summarise(sla = mean(StdValue))
```

Leaf area

```{r}
try_la1     <- rtry_import("data/try/try_LA1.txt", showOverview = FALSE)
try_la2     <- rtry_import("data/try/try_LA2.txt", showOverview = FALSE)

# data frame 
try_la <-
  bind_rows(try_la1, try_la1) %>% 
  dplyr::filter(str_detect(TraitName, "area")) %>% 
  filter(!is.na(StdValue)) %>% 
  group_by(AccSpeciesName) %>% 
  summarise(la = mean(StdValue))
```


### Austraits

```{r}
# loading data
austraits <- load_austraits(version = "3.0.2", path = "data/austraits")


# data frame excluding dispersal syndrome data
aust_trait <- 
  extract_trait(
    austraits, 
    c("leaf_area", "specific_leaf_area", "seed_mass", "plant_height")
    ) %>%
  pluck(1) %>% 
  group_by(taxon_name, trait_name) %>% 
  summarise(value = mean(value)) %>% 
  pivot_wider(names_from = trait_name, values_from = value) %>% 
  rename(
    sciname = taxon_name,
    sla = specific_leaf_area,
    height = plant_height,
    la = leaf_area 
  )
```
Combine the all of try data

```{r }
df_leaf <- 
  try_height %>% 
  dplyr::left_join(try_seed, by = "AccSpeciesName") %>% 
  dplyr::left_join(try_sla, by = "AccSpeciesName") %>% 
  dplyr::left_join(try_la, by = "AccSpeciesName") %>% 
  rename(sciname = AccSpeciesName) %>% 
  
  bind_rows(aust_trait) %>% 
  dplyr::group_by(sciname) %>% 
  dplyr::summarise(across(where(is.numeric), mean)) 
```

## Growth form

### Try
```{r}
try_life <-
  bind_rows(try_seed1, try_seed2) %>% 
  dplyr::filter(str_detect(TraitName, "longevity")) %>% 
  dplyr::mutate(
    
    # Annual
    annual = case_when(
      str_detect(
        OrigValueStr, 
        paste(c("annual","Annual","annuel", "> 1 year",
                "Biennial","biennial", "<2", "1-2", "1,2","Short"), 
              collapse = "|")) ~ 1,
      OriglName == "Annual" ~ 1,
      OriglName == "Biennial" ~ 1,
      OriglName == "annper" ~ 1,
      OriglName == "Plant phenology: Annual" ~ 1,
      OriglName == "Plant phenology: Biennial" ~ 1,
      OrigValueStr == "1" ~ 1,
      OrigValueStr == "2" ~ 1,
      OrigValueStr == "SL" ~ 1,
      UnitName == "year" & StdValue < 3 ~ 1),
    annual = if_else(is.na(annual), 0, 1),
    
    # Perennial
    perennial = case_when(
      str_detect(
        OrigValueStr, 
        paste(c("perennial", "Perennial",">10","-5","5-25","2 - 5",
                "Moderate","Long"), 
              collapse = "|")) ~ 1,
      OriglName == "Plant phenology: Perennial" ~ 1,
      OriglName == "Perennial" ~ 1,
      UnitName == "year" & StdValue > 2 & StdValue < 50 & StdValue != 12 ~ 1),
    perennial = if_else(is.na(perennial), 0, 1),
    
    
    # Tree
    tree = case_when(
      str_detect(
        OrigValueStr, 
        paste(c("tree", "woody"), 
              collapse = "|")) ~ 1,
       UnitName == "year" & StdValue >= 50 ~ 1),
     tree = if_else(is.na(tree), 0, 1)
    ) %>%
  
  dplyr::group_by(AccSpeciesName) %>% 
  dplyr::summarise(across(annual:tree, max)) %>% 
  dplyr::rename(sciname = AccSpeciesName)
```


### Austrait
```{r}
#aust_life <-
  extract_trait(austraits, "life_history") %>% 
  pluck(1) %>% 
  dplyr::inner_join(
    extract_trait(austraits, "plant_growth_form") %>% 
      pluck(1),
    by = "taxon_name"
    ) %>% 
  dplyr::select(taxon_name, value.x, value.y) %>% 
  dplyr::rename(life = value.x, wood = value.y) %>% 
  dplyr::mutate(
    annual = if_else(str_detect(life, "annual|biennial"), 1, 0),
    perennial = if_else(str_detect(life, "perennial"), 1, 0),
    tree = if_else(str_detect(wood, "tree|shrub"), 1,0),
    
    perennial = if_else(tree == 1, 0, perennial),
    annual = if_else(tree == 1, 0, annual)
    ) %>% 
  dplyr::select(-wood, -life) %>% 
  dplyr::filter(rowSums(across(where(is.numeric))) > 0) %>% 
  dplyr::group_by(taxon_name) %>% 
  dplyr::summarise(across(where(is.numeric), max)) %>% 
  dplyr::rename(sciname = taxon_name)
```


### Picture book
```{r}
# loading data
pic_data <- read_csv("data/SpeciesList_vegetation.csv")


# Data frame
pic_growth <- 
  pic_data %>% 
  dplyr::select(species, sciname_ylist, life) %>% 
  dplyr::filter(!is.na(life) & life != 0 & life != "-") %>% 
  dplyr::mutate(
    annual = if_else(str_detect(life, "1年|2年"), 1, 0),
    perennial = if_else(str_detect(life, "多年"), 1, 0),
    tree = if_else(str_detect(life, "木|本"), 1,0)
    ) %>% 
  dplyr::distinct(sciname_ylist, .keep_all = TRUE) %>% 
  dplyr::filter(sciname_ylist != "#N/A") %>% 
  dplyr::rename(sciname = sciname_ylist) %>% 
  dplyr::select(-life, -species)
```


Combine those data 
```{r}
df_growth <-
  dplyr::bind_rows(try_life, aust_life, pic_growth) %>% 
  dplyr::group_by(sciname) %>% 
  dplyr::summarise(across(where(is.numeric), sum)) %>% 
  
  # Deciding a growth form at each species
  pivot_longer(annual:tree) %>% 
  dplyr::group_by(sciname) %>% 
  dplyr::mutate(wood = if_else(name == "tree" & value == 1, "Tree", "Forb")) %>%
  dplyr::filter(value == max(value)) %>% 
  dplyr::mutate(
    growth = if_else(wood == "Tree", "tree", name),
    growth = as.factor(growth)) %>% 
  dplyr::select(sciname, growth) 
```


## Dispersal type 
Function of divide to dispersal category from words
```{r}
fun_dispersal <- function(df){

  df %>% 
    dplyr::mutate(
      wind = if_else(
        str_detect(
          dispersal,
          paste(c("wind","Wind","anemo","Anemo","herpochor",
                  "meteorochor","boleochor","chamaechor","semachor",
                  "風"),
                collapse = "|")
          ),
        1, 0),
      
      animal = if_else(
        str_detect(
          dispersal,
          paste(c("bird","Bird","cow","Animal","animal","Mammal","mammal",
            "zoochor","eate","Zoo","vertebrate", "goat",
            "Cattle","cattle","Ant","ants","pig","horse","mouse","donkey",
            "Vertebrate","vertebrate","cow","sheep","deer","rabbit",
            "dysochor","buffalo","snail","marten","wild","fish",
            "アリ","食","myrmecochory","dog", "insect","epizoochor",
            "endozoochor", "Sheep", "Civet", "Iridomyrmex sp.", "elaiosome",
            "earthworm", "chamois",
            
            # human dispersal
            "man","vehicle","agochor","ethelochor","commerce",
            "machinery","hemerochor","clothe","speirochor",
            "contamination", "cars", "mobile",
            "付着","体","adhesion"
            ),
            collapse = "|")),
        1, 0),
      
    water = if_else(
        str_detect(
          dispersal,
          paste(c("Water","water","hydro","rain","ombrochor","ombochor",
                  "海","水","雨"),
                collapse = "|")),
        1, 0),
    
    gravity = if_else(
        str_detect(
          dispersal,
          paste(c("Unassisted","drop","accidentally","Dispersal no",
                  "unassist","unspecialise","ballochor",
                  "Autocho","autocho","Barochory","barochory",
                  "Restricted","ballistic","blastochor",
                  "重力","自動","gravity"),
                collapse = "|")),
        1, 0)
    ) %>% 
  dplyr::mutate(
    animal = if_else(dispersal == "ant", 1, animal),
    gravity = if_else(dispersal == "Baro", 1, gravity),
    water = if_else(dispersal == "H", 1, water),
    wind = if_else(dispersal == "W", 1, wind),
    animal = if_else(dispersal == "Z", 1, animal),
    gravity = if_else(dispersal == "G", 1, gravity)
    ) %>% 
  as_tibble() 
}
```


### Try

```{r try dispersal}
# Load data
try_disper1 <- rtry_import("data/try/25827.txt", showOverview = FALSE)
try_disper2 <- rtry_import("data/try/25828.txt", showOverview = FALSE)

# data frame
try_disper <-
  bind_rows(try_disper1, try_disper2) %>% 
  dplyr::filter(
    str_detect(TraitName, "Dispersal") & 
      OriglName != "Seed Weight Notes"
    ) %>% 
  group_by(AccSpeciesName) %>% 
  distinct(DataName, OrigValueStr, OriglName) %>% 
  dplyr::rename(dispersal = OrigValueStr) %>% 
  fun_dispersal() %>% 
  dplyr::mutate(
    wind = if_else(str_detect(DataName, "wind"), 1, wind),
    animal = if_else(str_detect(DataName, "animal"), 1, animal),
    gravity = if_else(str_detect(DataName, "gravity"), 1, gravity),
    water = if_else(str_detect(DataName, "water"), 1, water),
    animal = if_else(str_detect(DataName, "biotic"), 1, animal),
    
    gravity = if_else(OriglName == "DispMode" & str_detect(dispersal,"G"),
                      1, gravity),
    wind = if_else(OriglName == "DispMode" & str_detect(dispersal,"W"),
                   1, wind),
    water = if_else(OriglName == "DispMode" & str_detect(dispersal,"H"),
                    1, water),
    animal = if_else(
      OriglName == "DispMode" & 
        str_detect(dispersal, 
                   paste(c("Z","P","M","N","O"), collapse = "|")),
                   1, animal),
    sum = rowSums(across(where(is.numeric)))
  ) %>% 
  filter(sum != 0) %>% 
  dplyr::rename(sciname = AccSpeciesName) %>% 
  #left_join(select(plant_sci, species, sciname), by = "sciname") %>% 
  #filter(!is.na(species)) %>% 
  dplyr::select(-DataName:-dispersal, -sum) %>% 
  
  group_by(sciname) %>% 
  summarise(across(where(is.numeric), max))
```

### Picture book

```{r}
# loading data
pic_data <- read_csv("data/SpeciesList_vegetation.csv")


# Data frame
pic_disper <- 
  pic_data %>% 
  dplyr::select(species, sciname_ylist, dispersal) %>% 
  dplyr::filter(!str_detect(dispersal, c("-|不|sheet"))) %>% 
  dplyr::mutate(
    species = recode(
      species,
      "トゲヂシャ" = "トゲチシャ",
      "ヒナタイノコズチ" = "ヒナタイノコヅチ",
      "マハナシ" = "マメナシ",
      "マルバイチヤクソウ" = "マルバノイチヤクソウ",
      "アケビ" = "ゴヨウアケビ"
      )
    ) %>% 
  dplyr::distinct(sciname_ylist, .keep_all = TRUE) %>% 
  filter(sciname_ylist != "#N/A") %>% 
  fun_dispersal() %>% 
  dplyr::rename(sciname = sciname_ylist) %>% 
  dplyr::select(-dispersal)
```

### Austraits

```{r}
# loading data
austraits <- load_austraits(version = "3.0.2", path = "data/austraits")


# dispersal of 
aust_disper <- 
  extract_trait(austraits, "dispersal_syndrome") %>% 
  pluck(1) %>% 
  rename(dispersal = value) %>% 
  fun_dispersal() %>% 
  dplyr::mutate(sum = wind + animal + water + gravity) %>% 
  dplyr::filter(sum != 0) %>% 
  dplyr::select(taxon_name, wind:gravity) %>% 
  dplyr::rename(sciname = taxon_name)
```

### leda

```{r}
# loading data
leda <- read_csv("data/leda.csv")

# Data frame
leda_disper <- 
  leda %>% 
    dplyr::select("SBS name", "dispersal type") %>% 
    dplyr::rename(sciname = "SBS name", dispersal = "dispersal type") %>% 
    dplyr::filter(dispersal != "") %>% 
    fun_dispersal() %>% 
    mutate(sum = wind + animal + water + gravity) %>% 
    filter(sum != 0) %>% 
    dplyr::select(-dispersal, -sum)
```

Combine all data of dispersal type 

```{r}
df_disper <- 
  bind_rows(try_disper, pic_disper, aust_disper, leda_disper) %>% 
  dplyr::group_by(sciname) %>% 
  dplyr::summarise(across(where(is.numeric), sum)) %>% 
  dplyr::mutate(disper = colnames(df_disper)[-1][max.col(across(-sciname))]) %>%
  dplyr::select(-wind:-gravity)
```

## Exotic species
```{r}
YList <- read_csv("data/YList.csv")

df_ylist <- 
  YList %>% 
  select(和名,生態)　%>% 
  rename(species = 和名,  exotic = 生態) %>% 
  mutate(exotic = if_else(is.na(exotic), "Native", "Exotic")) %>% 
  filter(species != "") %>% 
  distinct(species, .keep_all = TRUE) %>% 
  mutate(exotic = if_else(exotic == "","Native", exotic)) 


# including details of exotic species
ylist_detail <- 
  YList %>% 
  select(和名, 別名, 学名, 生態)　%>% 
  rename(species = 和名,  other_name = 別名, sciname = 学名, 
         exotic = 生態) %>% 
  filter(species != "") %>% 
  distinct(species, .keep_all = TRUE) %>% 
  mutate(exotic = recode(
    exotic,
    "帰" = "immigration",
    "栽" = "ornament",
    "外" = "exotic",
    "外?" = "exotic",
    "帰?" = "immigration",
    "帰 ?" = "immigration",
    "不明" = "unknown",
    "不明種" = "unknown"
    )) %>% 
  mutate(exotic = if_else(is.na(exotic), "Native", exotic))
```

## All trait data
Data frame for scientific name and japanese name

```{r}
plantsci <- read_csv("data/plant_japan_sciname.csv")

# data frame
plant_sci <- 
  plantsci %>%  
  dplyr::select("common name", "scientific name without author") %>% 
  dplyr::rename(
    sciname = "scientific name without author",
    species = "common name"
    ) %>% 
  distinct(species, .keep_all = TRUE) %>% 
  arrange(species) %>% 
  filter(!str_detect(species, "no_named"))
```

Combine 
```{r}
df_trait <-
  plant_sci %>% 
  dplyr::left_join(df_leaf, by = "sciname") %>% 
  dplyr::left_join(df_growth, by = "sciname") %>% 
  dplyr::left_join(df_disper, by = "sciname") %>% 
  dplyr::left_join(df_ylist, by = "species")
```



# Analysis

Load a survey data (plant and Environment)

```{r}
plant <- read_csv("data/df_plant.csv")
env   <- read_csv("data/Environment.csv")

df_plant <- 
  plant %>% 
  dplyr::mutate(time = if_else(str_detect(site, "過去"), "past", "now")) %>% 
  dplyr::select(site, time, everything()) %>% 
  dplyr::mutate(site = str_sub(site, end = -3)) %>% 
  pivot_longer(cols = -c(site, time), names_to = "species") 
```


Combine the survey, dispersal, and exotic data

```{r}
df_plant_trait <- 
  df_plant %>% 
  left_join(df_trait, by = "species") 
```

Number of species without dispersal type data

```{r}
df_plant_trait %>% 
  distinct(species, .keep_all = TRUE) %>% 
  filter(is.na(growth))
```





## Species richness

Estimate a species richness

```{r}
sr_plant <-
  df_plant_trait %>% 
    dplyr::filter(value == 1 & exotic != is.na(exotic)) %>% 
    group_by(site, time, exotic) %>% 
    dplyr::summarise(sr = n_distinct(species), .groups = "drop") %>% 
    pivot_wider(names_from = "exotic", values_from = "sr",
                values_fill = list(sr = 0)) %>% 
    mutate(All = Native + Exotic) %>% 
    pivot_longer(c(All, Native, Exotic), 
                 values_to = "sr", names_to = "exotic") %>% 
    mutate(
    exotic = recode_factor(
      exotic, 
      "All" = "All species",
      "Native" = "Native species",
      "Exotic" = "Exotic species"),
    time = recode_factor(
      time,
      "past" = "Past",
      "now"  = "Now")
    ) 
```

### Boxplot

Comparison of species richness

```{r}
box_sr_plant <- 
  ggplot(data = sr_plant,
         aes(x = time, y = sr, fill = time)) +
    geom_boxplot() + 
    geom_point(color = "grey50", size = 1, alpha = 0.5) +
    geom_line(aes(group = site), 
              color = "grey50", linewidth = 0.5, alpha = 0.5) +
    facet_wrap(~exotic, ncol = 3) +
    labs(
      x = "Time",
      y = "Species richness",
      fill = "Time",
      title = "Plant"
    ) +
    theme_bw(base_size = 8) +
    theme(
      panel.grid = element_blank(),
      legend.position = "none"
      )

box_sr_plant
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  box_sr_plant,
  file = "output/box_sr_plant.png",
  width = 130, height = 60, units = "mm", dpi = 500)
```

## Lost-added species
Estimate a lost and adding species 

```{r}
df_plant_lost_add <-
  df_plant %>% 
    pivot_wider(names_from = time, values_from = value) %>% 
    dplyr::mutate(
      lost = if_else(past == 1 & now == 0, 1, 0),
      add  = if_else(past == 0 & now == 1, 1, 0)
      ) %>% 
    dplyr::left_join(df_trait, by = "species") %>% 
    dplyr::left_join(env, by = "site") %>% 
    dplyr::filter(!is.na(exotic)) 
```


### Lost species 



```{r}
df_plant_lost_add %>% 
  dplyr::filter(past == 1) %>% 
  dplyr::mutate(across(where(is.character), as.factor)) %>% 
  glm(lost ~ growth + disper, family = "binomial", data = .) %>%   
  
  glht(linfct=mcp(disper = "Tukey")) %>% 
  tidy()
```






#### Dispersal type
Comparison of lost of species richness across dispersal type

```{r}
#box_lost_plant_disper <- 
  df_plant_lost_add %>% 
  dplyr::filter(lost == 1) %>% 
  drop_na(wind:gravity) %>% 
  group_by(site, exotic) %>% 
  summarise(across(wind:gravity, sum)) %>% 
  pivot_longer(-c(site, exotic)) %>% 
  mutate(
    exotic = recode_factor(
      exotic, 
      "Native" = "Native species",
      "Exotic" = "Exotic species"),
    name = recode(
        name,
        "wind" = "Wind",
        "animal" = "Animal",
        "water" = "Water",
        "gravity" = "Gravity")
        ) %>% 
  
  # Plot
  ggplot(aes(x = name, y = value, fill = name)) +
    geom_boxplot() +
    facet_wrap(~exotic, ncol = 2) + 
    labs(
      x = "Dispersal type",
      y = "Losted species richness"
    ) +
    scale_fill_simpsons() +
    theme_bw(base_size = 8) +
    theme(
      legend.position = "none",
      panel.grid = element_blank()
    )

box_lost_plant_disper
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  box_lostsr,
  file = "output/box_lostsr.png",
  width = 120, height = 70, units = "mm", dpi = 500)
```

#### Growth form
Comparison of lost of species richness across growth form

GLM
```{r}
glm_plant_lost_trait <- 
  df_plant_lost_add %>% 
    filter(past == 1) %>% 
    dplyr::mutate(across(where(is.character), as.factor)) %>% 
    #drop_na(growth) %>% 
    group_by(exotic) %>% 
    nest() %>% 
    mutate(
      # GLM
      fit = map(data, ~glm(lost ~ year + area + green_rate + growth + disper, family = "binomial", data = .)),
      summary_fit = map(fit, ~tidy(.)),
      
      # Growth form
      multi_grow = map(fit, ~glht(., linfct = mcp(growth = "Tukey"))),
      multi_grow_summary = map(multi_grow, ~tidy(.)),
      multi_grow_char = map(multi_grow, ~cld(., decreasing = F)),
      multi_grow_plot = map(
        data,
        ~ group_by(., growth) %>%
          dplyr::summarise(mean = mean(lost), sd = sd(lost), n = n()) %>% 
          dplyr::mutate(
            se = sd / sqrt(n),
            lowerCI = mean - qt(1 - (0.05 / 2), n - 1) * se,
            upperCI = mean + qt(1 - (0.05 / 2), n - 1) * se) %>%
          na.omit()),
      
      # Dispersal type
      multi_disper = map(fit, ~glht(., linfct = mcp(disper = "Tukey"))),
      multi_dipser_summary = map(multi_disper, ~tidy(.)),
      multi_disper_char = map(multi_disper, ~cld(., decreasing = F)),
      multi_disper_plot = map(
        data,
        ~ group_by(., disper) %>%
          dplyr::summarise(mean = mean(lost), sd = sd(lost), n = n()) %>% 
          dplyr::mutate(
            se = sd / sqrt(n),
            lowerCI = mean - qt(1 - (0.05 / 2), n - 1) * se,
            upperCI = mean + qt(1 - (0.05 / 2), n - 1) * se) %>%
          na.omit())
      ) 
```

```{r}
glm_plant_lost_trait %>% 
  dplyr::select(summary_fit) %>% 
  unnest()

df_plant_lost_add %>% 
    filter(past == 1) %>% 
    group_by(exotic) %>% 
        ~ group_by(., disper) %>%
          dplyr::summarise(mean = mean(lost), sd = sd(lost), n = n()) %>% 
          dplyr::mutate(
            se = sd / sqrt(n),
            lowerCI = mean - qt(1 - (0.05 / 2), n - 1) * se,
            upperCI = mean + qt(1 - (0.05 / 2), n - 1) * se) %>%
          na.omit())
```



Boxplot
```{r}
glm_plant_lost_trait %>% 
  dplyr::select(exotic, multi_grow_plot) %>% 
  unnest(multi_grow_plot) %>% 
   mutate(
    exotic = recode_factor(
      exotic, 
      "Native" = "Native species",
      "Exotic" = "Exotic species"),
    growth = recode(
      growth,
      "annual" = "Annual",
      "perennial" = "Perennial",
      "tree" = "Tree")
        ) %>% 
  ggplot(aes(x = exotic, y = mean,
         ymin = lowerCI, ymax = upperCI,
         group = growth, color = growth)) +
  geom_pointrange(position = position_dodge(width = 0.5))
```
Boxplot
```{r}
glm_plant_lost_trait %>% 
  dplyr::select(exotic, multi_disper_plot) %>% 
  unnest(multi_disper_plot) %>% 
   mutate(
    exotic = recode_factor(
      exotic, 
      "Native" = "Native species",
      "Exotic" = "Exotic species"),
     disper = recode(
        disper,
        "wind" = "Wind",
        "animal" = "Animal",
        "water" = "Water",
        "gravity" = "Gravity")
        ) %>% 
  ggplot(aes(x = exotic, y = mean,
         ymin = lowerCI, ymax = upperCI,
         group = disper, color = disper)) +
  geom_pointrange(position = position_dodge(width = 0.5))
```

```{r}
#box_lost_plant_growth <- 
  df_plant_lost_add %>% 
  dplyr::filter(lost == 1) %>% 
  drop_na(growth) 
  mutate(
    exotic = recode_factor(
      exotic, 
      "Native" = "Native species",
      "Exotic" = "Exotic species"),
    name = recode(
        name,
        "annual" = "Annual",
        "perennial" = "Perennial",
        "tree" = "Tree")
        ) %>% 
  
  # Plot
  ggplot(aes(x = name, y = value, fill = name)) +
    geom_boxplot() +
    facet_wrap(~exotic, ncol = 2) + 
    geom_text(
      data = data_frame(
        exotic = c(rep(c("Native species","Exotic species"), each = 3)),
        label = c("a","b","c","a","a","a")),
      aes(y = 200, label = label)
    )
    labs(
      x = "Growth form",
      y = "Losted species richness"
    ) +
    scale_fill_simpsons() +
    theme_bw(base_size = 8) +
    theme(
      legend.position = "none",
      panel.grid = element_blank()
    )

box_lost_plant_growth
```






#### GLM

Relationships between lost of species richness and environment

```{r}
glm_lost_plant_growth <- 
  df_plant_lost_add %>% 
    drop_na(growth) %>% 
    group_by(exotic) %>% 
    nest() %>% 
    mutate(
      fit = map(data, ~glm(lost ~ growth, family = "binomial", data = .)),
      summary_fit = map(fit, ~tidy(.)),
      
      multi = map(fit, ~multcomp::glht(., linfct = mcp(growth = "Tukey"))),
      multi_summary = map(multi, ~tidy(.)),
      multi_char = map(multi, ~cld(., decreasing = F))
      ) %>% 
    ungroup() 
```




Table for result of GLM

```{r}
table_glm_sr_lost_plant <- 
  glm_sr_lost %>% 
    select(exotic, name, summary) %>% 
    unnest(cols = summary) %>% 
    filter(term != "(Intercept)") %>% 
    mutate(
      across(estimate:statistic, ~round(., digits = 3)),
      p.value = if_else(p.value > 0.001, 
                        formatC(p.value, digits = 3, format = "fg"),
                        formatC(p.value, digits = 3, format = "e"))
      ) %>% 
    arrange(desc(exotic), name) %>% 
    rename(Nativity = exotic,
           "Dispersal type" = name,
           "Explanatory variables" = term,
           Estimate = estimate,
           Std.error = std.error,
           Statistic = statistic) %>% 
    print()
```

```{r eval=FALSE}
# Confirmation of significant explanatory variables
 glm_sr_lost %>% 
    select(exotic, name, summary) %>% 
    unnest(cols = summary) %>% 
    filter(term != "(Intercept)") %>% 
  filter(p.value <= 0.05) %>% 
  arrange(term)
```

#### Scatter lot

Data frame for ggplot

```{r}
df_p_glm_lost <- 
  sr_lost %>% 
    as_tibble() %>% 
    left_join(env, by = "site") %>% 
    pivot_longer(cols = c("wind","animal","water","gravity"),
                 values_to = "sr") %>% 
    mutate(
      exotic = recode_factor(
        exotic, 
        "Native" = "Native species",
        "Exotic" = "Exotic species"),
      name = recode(
        name,
        "wind" = "Wind",
        "animal" = "Animal",
        "water" = "Water",
        "gravity" = "Gravity")
        ) %>% 
    print()
```

Plot of result of GLM

```{r}
theme_set(theme_classic(base_size = 9))

# Year
p_glm_lost_year <- 
  df_p_glm_lost %>% 
    ggplot(aes(x = year, y = sr, color = name)) +
      geom_point() +
      geom_smooth(method = "glm", 
                  method.args = list(family = "poisson"),
                  se = F) +
      facet_wrap(exotic ~., scales = "free", ncol = 1, 
                 strip.position = 'left') +
      labs(
        x = "Year",
        y = "Losted species richness",
        color = "Dispersal type"
      ) +
      scale_color_simpsons() +
      theme(
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_text(size = 9)
        )


# Area
p_glm_lost_area <- 
  ggplot() +
    geom_point(
      data = df_p_glm_lost,
      aes(x = area/10000, y = sr, color = name)) +
    geom_smooth(
      data = df_p_glm_lost %>% 
        filter(name == "Gravity" | name == "Wind" | 
                 (exotic == "Exotic species" & name == "Animal")) ,
      aes(x = area/10000, y = sr, color = name),
      method = "glm", 
      method.args = list(family = "poisson"),
      se = F) +
      facet_wrap(exotic~., scales = "free", ncol = 1) +
      labs(
        x = "Area (ha)",
        y = "",
        color = "Dispersal type"
      ) +
      scale_color_simpsons() +
      theme(
        axis.title.y = element_blank(),
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_blank()
      )


# Green rate
p_glm_lost_rate <- 
  ggplot() +
    geom_point(
      data = df_p_glm_lost,
      aes(x = green_rate, y = sr, color = name)) +
    geom_smooth(
      data = df_p_glm_lost %>% 
        filter(exotic == "Native species" & name != "Gravity"),
      aes(x = green_rate, y = sr, color = name),
      method = "glm", 
      method.args = list(family = "poisson"),
      se = F) +
      facet_wrap(exotic~., scales = "free", ncol = 1) + 
      labs(
        x = "Green rate",
        y = "",
        color = "Dispersal type"
      ) +
      scale_color_simpsons() +
      theme(
        axis.title.y = element_blank(),
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_blank()
      )



# Combine
p_glm_lost_year + p_glm_lost_area + p_glm_lost_rate +
   plot_layout(guides = 'collect')
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  p_glm_lost_year + p_glm_lost_area + p_glm_lost_rate +
  plot_layout(guides = 'collect'),
  file = "output/plot_glm_lostsr.png",
  width = 160, height = 90, units = "mm", dpi = 500)
```

### Add species richness

#### Boxplot

Comparison of added species richness

```{r}
box_addsr <- 
  sr_add %>% 
  pivot_longer(-c(site, exotic)) %>% 
  mutate(
    exotic = recode_factor(
      exotic, 
      "Native" = "Native species",
      "Exotic" = "Exotic species"),
    name = recode(
        name,
        "wind" = "Wind",
        "animal" = "Animal",
        "water" = "Water",
        "gravity" = "Gravity")
        ) %>% 
  ggplot(aes(x = name, y = value, fill = name)) +
    geom_boxplot() +
    facet_wrap(~exotic, ncol = 2) + 
    labs(
      x = "Dispersal type",
      y = "Added species richness"
    ) +
    scale_fill_simpsons() +
    theme_bw(base_size = 8) +
    theme(
      legend.position = "none",
      panel.grid = element_blank()
    )

box_addsr
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  box_addsr,
  file = "output/box_addedsr.png",
  width = 120, height = 70, units = "mm", dpi = 500)
```

#### GLM

Relationships between added species richness and environment

```{r}
sr_add_nest <- 
  sr_add %>% 
    as_tibble() %>% 
    left_join(env, by = "site") %>% 
    mutate(across(year:green_rate, ~scale(.))) %>% 
    pivot_longer(cols = c("wind","animal","water","gravity"),
                 values_to = "sr") %>% 
    group_by(exotic, name) %>% 
    nest()
```

Do a GLM model

```{r}
glm_sr_add <- 
  sr_add_nest %>% 
    mutate(
      fit = map(data, ~glm(sr ~ year + area + green_rate, 
                           family = "poisson", data = .)),
      summary = map(fit, ~tidy(.))
      )

glm_sr_add
```

Table for result of GLM

```{r}
table_glm_sr_add_plant <- 
  glm_sr_add %>% 
    select(exotic, name, summary) %>% 
    unnest(cols = summary) %>% 
    filter(term != "(Intercept)") %>%
    mutate(
      across(estimate:statistic, ~round(., digits = 3)),
      p.value = if_else(abs(p.value) > 0.001, 
                        formatC(p.value, digits = 3, format = "fg"),
                        formatC(p.value, digits = 3, format = "e"))
      ) %>% 
    arrange(desc(exotic), name) %>% 
    rename(Nativity = exotic,
           "Dispersal type" = name,
           "Explanatory variables" = term,
           Estimate = estimate,
           Std.error = std.error,
           Statistic = statistic) %>% 
    print()
```

```{r eval=FALSE}
# confirmation
glm_sr_add %>% 
  select(exotic, name, summary) %>% 
  unnest(cols = summary) %>% 
  filter(term != "(Intercept)") %>% 
  filter(p.value <= 0.05) %>% 
  arrange(term)
```

#### Scatter plot

Data frame for ggplot

```{r}
df_p_glm_add <- 
  sr_add %>% 
    as_tibble() %>% 
    left_join(env, by = "site") %>% 
    pivot_longer(cols = c("wind","animal","water","gravity"),
                 values_to = "sr") %>% 
    mutate(
      exotic = recode_factor(
        exotic, 
        "Native" = "Native species",
        "Exotic" = "Exotic species"),
      name = recode(
        name,
        "wind" = "Wind",
        "animal" = "Animal",
        "water" = "Water",
        "gravity" = "Gravity")
        ) %>% 
    print()
```

Plot of result of GLM

```{r}
theme_set(theme_classic(base_size = 9))

# Year
p_glm_add_year <- 
  ggplot() +
    geom_point(
      data =  df_p_glm_add,
      aes(x = year, y = sr, color = name)) +
    geom_smooth(
      data =  df_p_glm_add %>% 
        filter(exotic == "Native species" & name == "Animal"), 
      aes(x = year, y = sr, color = name),
      method = "glm", 
      method.args = list(family = "poisson"),
                  se = F) +
      facet_wrap(exotic ~., scales = "free", ncol = 1, 
                 strip.position = 'left') +
      labs(
        x = "Year",
        y = "Added species richness",
        color = "Dispersal type"
      ) +
      scale_color_simpsons() +
      theme(
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_text(size = 9)
        )




# Area
p_glm_add_area <- 
  ggplot() +
    geom_point(
      data = df_p_glm_add,
      aes(x = area/10000, y = sr, color = name)) +
    geom_smooth(
      data = df_p_glm_add %>% 
        filter(!(exotic == "Exotic species" & name == "Water")) ,
      aes(x = area/10000, y = sr, color = name),
      method = "glm", 
      method.args = list(family = "poisson"),
      se = F) +
      facet_wrap(exotic~., scales = "free", ncol = 1,
                 strip.position = 'left') +
      labs(
        x = "Area (ha)",
        y = "",
        color = "Dispersal type"
      ) +
      scale_color_simpsons() +
      theme(
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_blank()
      )


# Green rate
p_glm_add_rate <- 
  ggplot() +
    geom_point(
      data = df_p_glm_add,
      aes(x = green_rate, y = sr, color = name)) +
    geom_smooth(
      data = df_p_glm_add %>% 
        filter(exotic == "Native species" &
                 (name == "Animal" | name == "Wind")),
      aes(x = green_rate, y = sr, color = name),
      method = "glm", 
      method.args = list(family = "poisson"),
      se = F) +
      facet_wrap(exotic~., scales = "free", ncol = 1) + 
      labs(
        x = "Green rate",
        y = "",
        color = "Dispersal type"
      ) +
      scale_color_simpsons() +
      theme(
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_blank()
      )



# Combine
 p_glm_add_year + p_glm_add_area + p_glm_add_rate +
   plot_layout(guides = 'collect')
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  p_glm_add_area + p_glm_add_rate + plot_layout(guides = 'collect'),
  file = "output/plot_glm_addedsr.png",
  width = 130, height = 90, units = "mm", dpi = 500)
```

# Species composition

```{r}
comm_plant <- 
  df_plant_disper %>% 
  dplyr::select(site:value, exotic) %>% 
  pivot_wider(names_from = species, values_from = value, values_fill = 0) %>% 
  na.omit() %>% 
  group_by(exotic) %>% 
  nest() %>% 
  ungroup() %>% 
  dplyr::mutate(
    comm = map(data, ~dplyr::select(., where(~is.numeric(.) && sum(.) != 0))), 
    
    # NMDS
    nmds = map(comm, 
               ~metaMDS(., dist = "jac", k = 2, trace = F, trymax = 999)),
    
    # NMDS axis score
    nmds_score = map(nmds, ~scores(.) %>% pluck(1) %>% as.data.frame()),
    
    # NMDS stress value
    nmds_stress = map_dbl(nmds, ~.$stress),
    
    # permanova
    permanova = map(data, ~adonis2(.[,-1:-2] ~ .$time, method = "jac")),
    
    
    # p-value from permanova
    pval = map(permanova, ~as.tibble(.) %>% dplyr::select("Pr(>F)")),
    
    
    exotic = recode_factor(exotic, 
                           "Native" = "Native species",
                           "Exotic" = "Exotic species")
    ) %>% 
  print()
```

## Permanova

```{r}
df_label_plant <-
  comm_plant %>% 
    dplyr::select(exotic, nmds_stress, pval) %>% 
    unnest(pval) %>% 
    na.omit() %>% 
    dplyr::mutate(
      across(where(is.numeric), ~round(., digits = 3)),
      time = "Past",
      stressvalue = "Stress value:",
      permanova_cha = "Permanova: p = "
      ) %>% 
    unite(stress, stressvalue, nmds_stress, remove = F, sep = "") %>% 
    unite(permanova, permanova_cha, "Pr(>F)", remove = F, sep = "") %>% 
    print()
```

Plot for result of nmds

```{r}
p_nmds_plant <- 
  comm_plant %>% 
  dplyr::select(exotic, nmds_score) %>% 
  unnest(nmds_score) %>% 
  mutate(
    time = rep(c("Past", "Now"), 30),
    time = factor(time, levels = c("Past", "Now"))) %>% 
  
    ggplot(aes(x = NMDS1, y = NMDS2, color = time)) +
      geom_point() +
      stat_ellipse(
        aes(group = time, fill = time), 
        alpha = 0.1,
        geom = "polygon") +
      facet_wrap(.~exotic) +
      
  
      # Stress value
      geom_text(
        data = df_label_plant, aes(label = stress), 
        x = 0.85, y = 1.2, size = 2, color = "grey50", hjust = 0) +
      
      # P value from Permanova
      geom_text(
        data = df_label_plant, aes(label = permanova), 
        x = 0.85, y = 1.1, size = 2, color = "grey50", hjust = 0) +
  
      theme_bw(base_size = 9) +
      theme(
        panel.grid = element_blank(),
        legend.position = c(0.1, 0.9),
        legend.title = element_blank(),
        legend.background = element_blank()
        )

p_nmds_plant
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  p_nmds_plant,
  file = "output/plot_nmds_plant.png",
  width = 170, height = 90, units = "mm", dpi = 500)
```

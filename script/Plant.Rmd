---
title: "Plant"
author: "ubd2751"
date: "2023-04-04"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  root.dir = "/temp")
```

# Package

```{r package, include=FALSE}
pacman::p_load(
  tidyverse,  # data management
  rtry, austraits,  # trait
  lme4, lmerTest, broom, multcomp, #GLM
  ggeffects, patchwork, ggsci, ggsignif,  # ggplot
  vegan # composition
  )

#remotes::install_github("traitecoevo/austraits", dependencies = TRUE, upgrade = "ask")
```

```{r include=FALSE}
# For read_csv
options(
  readr.num_columns = 0L,
  readr.show_col_types = FALSE,
  readr.show_progress = FALSE
)
```

# Data frame for trait

## Trait (leaf, seed)

### Try

Plant height

```{r try plant height}
# Load data
try_height1 <- rtry_import("data/try/try_height1.txt", showOverview = FALSE)
try_height2 <- rtry_import("data/try/try_height2.txt", showOverview = FALSE)

# data frame
try_height <-
  bind_rows(try_height1, try_height2) %>% 
  dplyr::filter(UnitName == "m" & !is.na(TraitID)) %>% 
  dplyr::mutate(height = as.numeric(StdValue)) %>% 
  dplyr::group_by(AccSpeciesName) %>% 
  dplyr::summarise(height = mean(height)) 
```

Seed mass & Life form

```{r try seed life}
# Load data
try_seed1   <- rtry_import("data/try/try_seed1.txt", showOverview = FALSE)
try_seed2   <- rtry_import("data/try/try_seed2.txt", showOverview = FALSE)


# data frame for seed mass
try_seed <-
  bind_rows(try_seed1, try_seed2) %>% 
  dplyr::filter(str_detect(TraitName, "Seed")) %>% 
  dplyr::filter(!is.na(StdValue)) %>% 
  dplyr::group_by(AccSpeciesName) %>% 
  dplyr::summarise(seed_mass = mean(StdValue))
```

Specific leaf area

```{r}
try_sla1    <- rtry_import("data/try/try_SLA1.txt", showOverview = FALSE)
try_sla2    <- rtry_import("data/try/try_SLA2.txt", showOverview = FALSE)

# data frame 
try_sla <-
  bind_rows(try_sla1, try_sla1) %>% 
  dplyr::filter(str_detect(TraitName, "area")) %>% 
  dplyr::filter(!is.na(StdValue)) %>% 
  dplyr::group_by(AccSpeciesName) %>% 
  dplyr::summarise(sla = mean(StdValue))
```

Leaf area

```{r}
try_la1     <- rtry_import("data/try/try_LA1.txt", showOverview = FALSE)
try_la2     <- rtry_import("data/try/try_LA2.txt", showOverview = FALSE)

# data frame 
try_la <-
  bind_rows(try_la1, try_la1) %>% 
  dplyr::filter(str_detect(TraitName, "area")) %>% 
  dplyr::filter(!is.na(StdValue)) %>% 
  dplyr::group_by(AccSpeciesName) %>% 
  dplyr::summarise(la = mean(StdValue))
```

### Austraits

```{r}
# loading data
austraits <- load_austraits(version = "3.0.2", path = "data/austraits")


# data frame excluding dispersal syndrome data
aust_trait <- 
  extract_trait(
    austraits, 
    c("leaf_area", "specific_leaf_area", "seed_mass", "plant_height")
    ) %>%
  pluck(1) %>% 
  dplyr::group_by(taxon_name, trait_name) %>% 
  dplyr::summarise(value = mean(value)) %>% 
  pivot_wider(names_from = trait_name, values_from = value) %>% 
  dplyr::rename(
    sciname = taxon_name,
    sla = specific_leaf_area,
    height = plant_height,
    la = leaf_area 
    )
```

Combine the all of try data

```{r }
df_leaf <- 
  try_height %>% 
  dplyr::left_join(try_seed, by = "AccSpeciesName") %>% 
  dplyr::left_join(try_sla, by = "AccSpeciesName") %>% 
  dplyr::left_join(try_la, by = "AccSpeciesName") %>% 
  dplyr::rename(sciname = AccSpeciesName) %>% 
  
  bind_rows(aust_trait) %>% 
  dplyr::group_by(sciname) %>% 
  dplyr::summarise(across(where(is.numeric), mean)) 
```

## Growth form

### Try

```{r}
try_life <-
  bind_rows(try_seed1, try_seed2) %>% 
  dplyr::filter(str_detect(TraitName, "longevity")) %>% 
  dplyr::mutate(
    
    # Annual
    annual = case_when(
      str_detect(
        OrigValueStr, 
        paste(c("annual","Annual","annuel", "> 1 year",
                "Biennial","biennial", "<2", "1-2", "1,2","Short"), 
              collapse = "|")) ~ 1,
      OriglName == "Annual" ~ 1,
      OriglName == "Biennial" ~ 1,
      OriglName == "annper" ~ 1,
      OriglName == "Plant phenology: Annual" ~ 1,
      OriglName == "Plant phenology: Biennial" ~ 1,
      OrigValueStr == "1" ~ 1,
      OrigValueStr == "2" ~ 1,
      OrigValueStr == "SL" ~ 1,
      UnitName == "year" & StdValue < 3 ~ 1),
    annual = if_else(is.na(annual), 0, 1),
    
    # Perennial
    perennial = case_when(
      str_detect(
        OrigValueStr, 
        paste(c("perennial", "Perennial",">10","-5","5-25","2 - 5",
                "Moderate","Long"), 
              collapse = "|")) ~ 1,
      OriglName == "Plant phenology: Perennial" ~ 1,
      OriglName == "Perennial" ~ 1,
      UnitName == "year" & StdValue > 2 & StdValue < 50 & StdValue != 12 ~ 1),
    perennial = if_else(is.na(perennial), 0, 1),
    
    
    # Tree
    tree = case_when(
      str_detect(
        OrigValueStr, 
        paste(c("tree", "woody"), 
              collapse = "|")) ~ 1,
       UnitName == "year" & StdValue >= 50 ~ 1),
     tree = if_else(is.na(tree), 0, 1)
    ) %>%
  
  dplyr::group_by(AccSpeciesName) %>% 
  dplyr::summarise(across(annual:tree, max)) %>% 
  dplyr::rename(sciname = AccSpeciesName)
```

### Austrait

```{r}
aust_life <-
  extract_trait(austraits, "life_history") %>% 
  pluck(1) %>% 
  dplyr::inner_join(
    extract_trait(austraits, "plant_growth_form") %>% 
      pluck(1),
    by = "taxon_name"
    ) %>% 
  dplyr::select(taxon_name, value.x, value.y) %>% 
  dplyr::rename(life = value.x, wood = value.y) %>% 
  dplyr::mutate(
    annual = if_else(str_detect(life, "annual|biennial"), 1, 0),
    perennial = if_else(str_detect(life, "perennial"), 1, 0),
    tree = if_else(str_detect(wood, "tree|shrub"), 1,0),
    
    perennial = if_else(tree == 1, 0, perennial),
    annual = if_else(tree == 1, 0, annual)
    ) %>% 
  dplyr::select(-wood, -life) %>% 
  dplyr::filter(rowSums(across(where(is.numeric))) > 0) %>% 
  dplyr::group_by(taxon_name) %>% 
  dplyr::summarise(across(where(is.numeric), max)) %>% 
  dplyr::rename(sciname = taxon_name)
```

### Picture book

```{r}
# loading data
pic_data <- read_csv("data/SpeciesList_vegetation.csv")


# Data frame
pic_growth <- 
  pic_data %>% 
  dplyr::select(species, sciname_ylist, life) %>% 
  dplyr::filter(!is.na(life) & life != 0 & life != "-") %>% 
  dplyr::mutate(
    annual = if_else(str_detect(life, "1年|2年"), 1, 0),
    perennial = if_else(str_detect(life, "多年"), 1, 0),
    tree = if_else(str_detect(life, "木|本"), 1,0)
    ) %>% 
  dplyr::distinct(sciname_ylist, .keep_all = TRUE) %>% 
  dplyr::filter(sciname_ylist != "#N/A") %>% 
  dplyr::rename(sciname = sciname_ylist) %>% 
  dplyr::select(-life, -species)
```

Combine those data

```{r}
df_growth <-
  dplyr::bind_rows(try_life, aust_life, pic_growth) %>% 
  dplyr::group_by(sciname) %>% 
  dplyr::summarise(across(where(is.numeric), sum)) %>% 
  
  # Deciding a growth form at each species
  dplyr::mutate(growth = as.factor(dplyr::case_when(
    tree >= 1 ~ "tree",
    perennial >= 1 & tree == 0 ~ "perennial",
    annual >= 1 & tree == 0 ~ "annual",
    perennial > annual ~ "perennial",
    annual > perennial ~ "annual"))
    ) %>% 
  dplyr::select(sciname, growth) 
```

## Dispersal type

Function of divide to dispersal category from words

```{r}
fun_dispersal <- function(df){

  df %>% 
    dplyr::mutate(
      wind = if_else(
        str_detect(
          dispersal,
          paste(c("wind","Wind","anemo","Anemo","herpochor",
                  "meteorochor","boleochor","chamaechor","semachor",
                  "風"),
                collapse = "|")
          ),
        1, 0),
      
      animal = if_else(
        str_detect(
          dispersal,
          paste(c("bird","Bird","cow","Animal","animal","Mammal","mammal",
            "zoochor","eate","Zoo","vertebrate", "goat",
            "Cattle","cattle","Ant","ants","pig","horse","mouse","donkey",
            "Vertebrate","vertebrate","cow","sheep","deer","rabbit",
            "dysochor","buffalo","snail","marten","wild","fish",
            "アリ","食","myrmecochory","dog", "insect","epizoochor",
            "endozoochor", "Sheep", "Civet", "Iridomyrmex sp.", "elaiosome",
            "earthworm", "chamois",
            
            # human dispersal
            "man","vehicle","agochor","ethelochor","commerce",
            "machinery","hemerochor","clothe","speirochor",
            "contamination", "cars", "mobile",
            "付着","体","adhesion"
            ),
            collapse = "|")),
        1, 0),
      
    water = if_else(
        str_detect(
          dispersal,
          paste(c("Water","water","hydro","rain","ombrochor","ombochor",
                  "海","水","雨"),
                collapse = "|")),
        1, 0),
    
    gravity = if_else(
        str_detect(
          dispersal,
          paste(c("Unassisted","drop","accidentally","Dispersal no",
                  "unassist","unspecialise","ballochor",
                  "Autocho","autocho","Barochory","barochory",
                  "Restricted","ballistic","blastochor",
                  "重力","自動","gravity"),
                collapse = "|")),
        1, 0)
    ) %>% 
  dplyr::mutate(
    animal = if_else(dispersal == "ant", 1, animal),
    gravity = if_else(dispersal == "Baro", 1, gravity),
    water = if_else(dispersal == "H", 1, water),
    wind = if_else(dispersal == "W", 1, wind),
    animal = if_else(dispersal == "Z", 1, animal),
    gravity = if_else(dispersal == "G", 1, gravity)
    ) %>% 
  as_tibble() 
}
```

### Try

```{r try dispersal}
try_disper1 <- rtry_import("data/try/25827.txt", showOverview = FALSE)
try_disper2 <- rtry_import("data/try/25828.txt", showOverview = FALSE)


try_disper <-
  bind_rows(try_disper1, try_disper2) %>% 
  dplyr::filter(
    str_detect(TraitName, "Dispersal") & 
      OriglName != "Seed Weight Notes"
    ) %>% 
  group_by(AccSpeciesName) %>% 
  distinct(DataName, OrigValueStr, OriglName) %>% 
  dplyr::rename(dispersal = OrigValueStr) %>% 
  fun_dispersal() %>% 
  dplyr::mutate(
    wind = if_else(str_detect(DataName, "wind"), 1, wind),
    animal = if_else(str_detect(DataName, "animal"), 1, animal),
    gravity = if_else(str_detect(DataName, "gravity"), 1, gravity),
    water = if_else(str_detect(DataName, "water"), 1, water),
    animal = if_else(str_detect(DataName, "biotic"), 1, animal),
    
    gravity = if_else(OriglName == "DispMode" & str_detect(dispersal,"G"),
                      1, gravity),
    wind = if_else(OriglName == "DispMode" & str_detect(dispersal,"W"),
                   1, wind),
    water = if_else(OriglName == "DispMode" & str_detect(dispersal,"H"),
                    1, water),
    animal = if_else(
      OriglName == "DispMode" & 
        str_detect(dispersal, 
                   paste(c("Z","P","M","N","O"), collapse = "|")),
                   1, animal),
    sum = rowSums(across(where(is.numeric)))
  ) %>% 
  dplyr::filter(sum != 0) %>% 
  dplyr::rename(sciname = AccSpeciesName) %>% 
  #left_join(select(plant_sci, species, sciname), by = "sciname") %>% 
  #filter(!is.na(species)) %>% 
  dplyr::select(-DataName:-dispersal, -sum) %>% 
  
  dplyr::group_by(sciname) %>% 
  dplyr::summarise(across(where(is.numeric), max))
```

### Picture book

```{r}
# loading data
pic_data <- read_csv("data/SpeciesList_vegetation.csv")


# Data frame
pic_disper <- 
  pic_data %>% 
  dplyr::select(species, sciname_ylist, dispersal) %>% 
  dplyr::filter(!str_detect(dispersal, c("-|不|sheet"))) %>% 
  dplyr::mutate(
    species = recode(
      species,
      "トゲヂシャ" = "トゲチシャ",
      "ヒナタイノコズチ" = "ヒナタイノコヅチ",
      "マハナシ" = "マメナシ",
      "マルバイチヤクソウ" = "マルバノイチヤクソウ",
      "アケビ" = "ゴヨウアケビ"
      )
    ) %>% 
  dplyr::distinct(sciname_ylist, .keep_all = TRUE) %>% 
  filter(sciname_ylist != "#N/A") %>% 
  fun_dispersal() %>% 
  dplyr::rename(sciname = sciname_ylist) %>% 
  dplyr::select(-dispersal)
```

### Austraits

```{r}
# loading data
austraits <- load_austraits(version = "3.0.2", path = "data/austraits")


# dispersal of 
aust_disper <- 
  extract_trait(austraits, "dispersal_syndrome") %>% 
  pluck(1) %>% 
  dplyr::rename(dispersal = value) %>% 
  fun_dispersal() %>% 
  dplyr::mutate(sum = wind + animal + water + gravity) %>% 
  dplyr::filter(sum != 0) %>% 
  dplyr::select(taxon_name, wind:gravity) %>% 
  dplyr::rename(sciname = taxon_name)
```

### leda

```{r}
# loading data
leda <- read_csv("data/leda.csv")

# Data frame
leda_disper <- 
  leda %>% 
    dplyr::select("SBS name", "dispersal type") %>% 
    dplyr::rename(sciname = "SBS name", dispersal = "dispersal type") %>% 
    dplyr::filter(dispersal != "") %>% 
    fun_dispersal() %>% 
    mutate(sum = wind + animal + water + gravity) %>% 
    filter(sum != 0) %>% 
    dplyr::select(-dispersal, -sum)
```

Combine all data of dispersal type

```{r}
df_disper <- 
  bind_rows(try_disper, pic_disper, aust_disper, leda_disper) %>% 
  dplyr::group_by(sciname) %>% 
  dplyr::summarise(across(where(is.numeric), sum)) %>% 
  dplyr::mutate(disper = colnames(.)[-1][max.col(across(-sciname))]) %>%
  dplyr::select(-wind:-gravity)
```

## Exotic species

```{r}
YList <- read_csv("data/YList.csv")

df_ylist <- 
  YList %>% 
  dplyr::select(和名,生態)　%>% 
  dplyr::rename(species = 和名,  exotic = 生態) %>% 
  dplyr::mutate(exotic = if_else(is.na(exotic), "Native", "Exotic")) %>% 
  dplyr::filter(species != "") %>% 
  dplyr::distinct(species, .keep_all = TRUE) %>% 
  dplyr::mutate(exotic = if_else(exotic == "","Native", exotic)) 
```

## All trait data

Data frame for scientific name and japanese name

```{r}
plantsci <- read_csv("data/plant_japan_sciname.csv")

# data frame
plant_sci <- 
  plantsci %>%  
  dplyr::select("common name", "scientific name without author") %>% 
  dplyr::rename(
    sciname = "scientific name without author",
    species = "common name"
    ) %>% 
  distinct(species, .keep_all = TRUE) %>% 
  arrange(species) %>% 
  dplyr::filter(!str_detect(species, "no_named"))
```

Combine

```{r}
df_trait <-
  plant_sci %>% 
    dplyr::left_join(df_leaf, by = "sciname") %>% 
    dplyr::left_join(df_growth, by = "sciname") %>% 
    dplyr::left_join(df_disper, by = "sciname") %>% 
    dplyr::left_join(df_ylist, by = "species")
```

Urbanization rate
```{r}
raw_buffer_LU <- read_csv("data/buffer_LU.csv")

urban_rate <- raw_buffer_LU %>% 
  dplyr::group_by(buffer_size, sitename, DN) %>% 
  dplyr::summarise(area = sum(area)) %>% 
  
  dplyr::group_by(buffer_size, sitename) %>% 
  dplyr::mutate(
    total_area = sum(area),
    rate = area/total_area
    ) %>% 
  dplyr::filter(DN == 2) %>% 
  ungroup() %>% 
  dplyr::select(-DN, -area, -total_area) %>% 
  dplyr::rename(site = sitename) %>% 
  dplyr::mutate(
    site = recode(
      site,
      "fuzisawa1" = "藤沢市1",
      "fuzisawa2" = "藤沢市2",
      "fuzisawa3" = "藤沢市3",
      "hukamisiminnnomori" = "大和市1",
      "maborisizennkyouikuenn" = "馬堀自然教育園",
      "nagareyama1" = "流山市1",
      "nagareyama2" = "流山市2",
      "nagareyama3" = "流山市3",
      "niiharusiminnnomori" = "新治市民の森",
      "oomatisizennkannsatuenn" = "大町公園自然観察園",
      "sizennkyouikuenn" = "自然教育園",
      "tamasinnrinnkagakuenn" = "多摩森林科学園",
      "toukyounougyoudaigakuatugi" = "東京農業大学",
      "yokohamakokuritudaigaku" = "横浜国立大学",
      "yokohamasizennkannsatunomori" = "横浜自然観察の森"
      )
    ) 
```



# Analysis

Load a survey data (plant and Environment)

```{r}
plant <- read_csv("data/df_plant.csv")
env   <- read_csv("data/Environment.csv")

df_plant <- 
  plant %>% 
  dplyr::mutate(time = if_else(str_detect(site, "過去"), "past", "now")) %>% 
  dplyr::select(site, time, everything()) %>% 
  dplyr::mutate(site = str_sub(site, end = -3)) %>% 
  pivot_longer(cols = -c(site, time), names_to = "species") 
```

Combine the survey, dispersal, and exotic data

```{r}
df_plant_trait <- 
  df_plant %>% 
  dplyr::inner_join(df_trait, by = "species") 
```

Number of species without dispersal type data

```{r}
df_plant_trait %>% 
  distinct(species, .keep_all = TRUE) %>% 
  filter(is.na(growth))
```

## Species richness

Estimate a species richness

```{r}
sr_plant <-
  df_plant_trait %>% 
    dplyr::filter(value == 1 & exotic != is.na(exotic)) %>% 
    group_by(site, time, exotic) %>% 
    dplyr::summarise(sr = n_distinct(species), .groups = "drop") %>% 
    pivot_wider(names_from = "exotic", values_from = "sr",
                values_fill = list(sr = 0)) %>% 
    dplyr::mutate(All = Native + Exotic) %>% 
    pivot_longer(c(All, Native, Exotic), 
                 values_to = "sr", names_to = "exotic") %>% 
    mutate(
    exotic = recode_factor(
      exotic, 
      "All" = "All species",
      "Native" = "Native species",
      "Exotic" = "Exotic species"),
    time = recode_factor(
      time,
      "past" = "Past",
      "now"  = "Present")
    ) 
```

```{r}
sr_plant %>% 
  left_join(urban_rate, by = "site") %>% 
  group_nest(buffer_size) %>% 
  dplyr::mutate(
    model = map(data, ~glm(sr ~ rate, family = "poisson", data = .)),
    AIC = map_dbl(model, ~AIC(.))
    )
  



glm_urban_plant_bf500 <- glm(sr)
```




Comparison between present and past using Wilcoxon signed rank test

```{r}
wlcx_sr_time <-
  sr_plant %>% 
  group_by(exotic) %>% 
  nest() %>% 
  mutate(
    wlcx_test = map(data, ~wilcox.test(sr ~ time, data =., paired = TRUE)),
    wlcx_summary = map(wlcx_test, ~tidy(.))
    )
```

P-value of wilcoxon test in the boxplot 
```{r}
p_val_wlcx_sr_time <- 
  wlcx_sr_time %>% 
   unnest(wlcx_summary) %>% 
   dplyr::select(exotic, p.value) %>% 
   dplyr::mutate(
     char = "p = ",
     p.value = round(p.value, 3)
     ) %>% 
   unite(col = char_pval, char, p.value, remove = F, sep = "")
```

Boxplot for comparison of species richnnes

```{r}
box_sr_plant <- 
  ggplot(data = sr_plant, aes(x = time, y = sr)) +
    geom_boxplot(aes(fill = time)) + 
    geom_point(color = "grey50", size = 0.5, alpha = 0.5) +
    geom_line(aes(group = interaction(site, exotic)), 
              color = "grey50", linewidth = 0.3, alpha = 0.5) +
    facet_wrap(~exotic, ncol = 3) +
    geom_signif(
      data = p_val_wlcx_sr_time,
      aes(y_position = c(850, 800, 200), 
          xmin = c(1, 1, 1), xmax = c(2, 2, 2),
          annotations = char_pval),
          size = 0.2, textsize = 2, manual = TRUE) +
    scale_y_continuous(limits = c(0, 900))+
    labs(
      x = "Time",
      y = "Species richness",
      fill = "Time"
      ) +
    theme_bw(base_size = 8) +
    theme(
      panel.grid = element_blank(),
      legend.position = "none",
      strip.background = element_blank(),
      strip.text = element_text(size = 8)
      )

box_sr_plant
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  box_sr_plant,
  file = "output/box_sr_plant.png",
  width = 130, height = 60, units = "mm", dpi = 500)
```

## Lost species

Estimate a number of lost species

```{r}
df_plant_lost <-
  df_plant %>% 
    pivot_wider(names_from = time, values_from = value) %>% 
    dplyr::mutate(lost = if_else(past == 1 & now == 0, 1, 0)) %>% 
    dplyr::left_join(df_trait, by = "species") %>% 
    dplyr::left_join(env, by = "site") %>% 
    dplyr::filter(!is.na(exotic) & past == 1) %>% 
    dplyr::mutate(across(where(is.character), as.factor))
```

Confirmation of number of lost species across dispersal type
```{r}
df_plant_lost %>% 
  dplyr::group_by(exotic, disper) %>% 
  dplyr::summarise(n = n_distinct(species)) %>% 
  na.omit()
```

### GLM

Relationships between lost species and trait, environmental variables

```{r}
glm_plant_lost <- 
  df_plant_lost %>% 
    dplyr::mutate(across(where(is.character), as.factor)) %>% 
    group_by(exotic) %>% 
    nest() %>% 
    mutate(
      
      # GLM
      fit = map(
        data, 
        ~glm(lost ~ year + area + green_rate + growth + disper, 
             family = "binomial", data = .)),
      summary_fit = map(fit, ~tidy(.)),
      
      
      # Growth form
      multi_grow = map(fit, ~glht(., linfct = mcp(growth = "Tukey"))),
      multi_grow_summary = map(multi_grow, ~tidy(.)),
      multi_grow_char = map(multi_grow, ~cld(., decreasing = F)),
      
      
      # Dispersal type
      multi_disper = map(fit, ~glht(., linfct = mcp(disper = "Tukey"))),
      multi_dipser_summary = map(multi_disper, ~tidy(.)),
      multi_disper_char = map(multi_disper, ~cld(., decreasing = F)),
      
      
      # Environment
      pred_year = map(fit, ~ggpredict(., terms = "year")),
      pred_area = map(fit, ~ggpredict(., terms = "area")),
      pred_green = map(fit, ~ggpredict(., terms = "green_rate"))
      ) 
```

Partial r squared
```{r eval=FALSE, include=FALSE}

# All species
glm_lost_plant <- 
  glm(lost ~ year + area + green_rate + growth + disper, 
      family = "binomial", data = df_plant_lost)

rsq_glm_lost_plant <- rsq.partial(glm_lost_plant, adj = TRUE)



# Native species
df_plant_lost_native <-
  df_plant_lost %>% 
    dplyr::filter(exotic == "Native" & !is.na(growth) & !is.na(disper)) 

glm_lost_plant_native <- 
  glm(lost ~ year + area + green_rate + growth + disper, 
      family = "binomial", data = df_plant_lost_native)

rsq_glm_lost_plant_native <- rsq.partial(glm_lost_plant_native, adj = TRUE)




# Exotic species
df_plant_lost_exotic <-
  df_plant_lost %>% 
    dplyr::filter(exotic == "Exotic" & !is.na(growth) & !is.na(disper)) 

glm_lost_plant_exotic <- 
  glm(lost ~ year + area + green_rate + growth + disper, 
      family = "binomial", data = df_plant_lost_exotic)

rsq_glm_lost_plant_exotic <- rsq.partial(glm_lost_plant_exotic, adj = TRUE)


df_rsq_glm_lost_plant <- 
  bind_rows(
    rsq_glm_lost_plant[2:3],
    rsq_glm_lost_plant_native[2:3],
    rsq_glm_lost_plant_exotic[2:3]
    ) %>% 
    dplyr::mutate(Nativity = rep(c("All", "Native","Exotic"), each = 5)) %>% 
  print()
```
```{r eval=FALSE, include=FALSE}
write.csv(df_rsq_glm_lost_plant, "output/rsq_glm_lost_plant.csv")
```



Table for result of GLM

```{r}
tb_glm_plant_lost <- 
  glm_plant_lost %>% 
    dplyr::select(exotic, summary_fit) %>% 
    unnest(summary_fit) %>% 
    dplyr::filter(term != "(Intercept)") %>% 
    dplyr::mutate(
      across(where(is.numeric),
             ~ifelse(. > -0.001 & . < 0.001,
                      formatC(., digits = 3, format = "e"),
                      formatC(., digits = 3, format = "fg"))
      )) %>% 
    dplyr::rename(
      Nativity = exotic,
      "Explanatory variables" = term,
      Estimate = estimate,
      Std.error = std.error,
      Statistic = statistic) %>% 
    print()
```

```{r eval=FALSE, include=FALSE}
write.csv(tb_glm_plant_lost, "output/glm_lost_plant.csv")
```



### Plot

#### Growth form

Character of result of GLM of growth form

```{r}
cha_glm_plant_lost_growth <-
  bind_rows(
    tidy(glm_plant_lost$multi_grow_char[[1]]),
    tidy(glm_plant_lost$multi_grow_char[[2]])
    ) %>% 
  mutate(
    exotic = fct_inorder(rep(c("Native species","Exotic species"), each = 3)),
    growth = fct_inorder(rep(c("Annual","Perennial","Tree"), 2))
    )
```

Plot for result of glm of growth form

```{r}
box_plant_lost_growth <- 
  df_plant_lost %>% 
    group_by(species, growth, exotic) %>% 
    dplyr::summarise(lost = mean(lost), .groups = "drop") %>% 
    dplyr::filter(!is.na(growth)) %>% 
    dplyr:: mutate(
      exotic = recode_factor(
        exotic,
        "Native" = "Native species",
        "Exotic" = "Exotic species"),
      growth = recode(
        growth,
        "annual" = "Annual",
        "perennial" = "Perennial",
        "tree" = "Tree")
        ) %>% 
  
    # plot
    ggplot() +
    geom_boxplot(aes(x = growth, y = lost, fill = exotic)) + 
    facet_grid(~exotic) +
    geom_text(
      data = cha_glm_plant_lost_growth, 
      aes(x = growth, y = 1.05, label = letters),
      position = position_dodge(width = 1), size = 3) +
    labs(
      x = "Growth form",
      y = "Probability of species loss",
      fill = "Growth form"
      ) +
    theme_classic(base_size = 8) +
    scale_fill_simpsons() +
    #scale_fill_brewer(palette = "Paired") +
    theme(
      panel.grid = element_blank(),
      legend.position = "none",
      strip.background = element_blank(),
      strip.text = element_text(size = 8)
      )

box_plant_lost_growth
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  box_plant_lost_growth,
  file = "output/box_plant_lost_growth.png",
  width = 100, height = 60, units = "mm", dpi = 500)
```

#### Dispersal type

Character of result of GLM of dispersal type

```{r}
cha_glm_plant_lost_disper <-
  bind_rows(
    tidy(glm_plant_lost$multi_disper_char[[1]]),
    tidy(glm_plant_lost$multi_disper_char[[2]])
    ) %>% 
  mutate(
    exotic = fct_inorder(rep(c("Native species","Exotic species"), each = 4)),
    growth = fct_inorder(rep(c("Animal","Gravity","Water","Wind"), 2))
    )
```

Plot for result of glm of growth form

```{r}
box_plant_lost_disper <- 
  df_plant_lost %>% 
    group_by(species, disper, exotic) %>% 
    dplyr::summarise(lost = mean(lost), .groups = "drop") %>% 
    dplyr::filter(!is.na(disper)) %>% 
    dplyr:: mutate(
      exotic = recode_factor(
        exotic,
        "Native" = "Native species",
        "Exotic" = "Exotic species"),
      disper = recode(
        disper,
        "wind" = "Wind",
        "animal" = "Animal",
        "water" = "Water",
        "gravity" = "Gravity")
        ) %>% 
  
    # plot
    ggplot() +
    geom_boxplot(aes(x = disper, y = lost, fill = exotic)) + 
    facet_grid(~exotic) +
    geom_text(
      data = cha_glm_plant_lost_disper, 
      aes(x = growth, y = 1.05, label = letters),
      position = position_dodge(width = 1), size = 3) +
    labs(
      x = "Dispersal type",
      y = "Probability of species loss"
      ) +
    theme_classic(base_size = 8) +
    scale_fill_simpsons() +
    theme(
      panel.grid = element_blank(),
      legend.position = "none",
      strip.background = element_blank(),
      strip.text = element_text(size = 8)
      )

box_plant_lost_disper
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  box_plant_lost_disper,
  file = "output/box_plant_lost_disper.png",
  width = 100, height = 60, units = "mm", dpi = 500)
```

#### Environment
Plot for the result of GLM of environmental variables
```{r}
theme_set(theme_bw(base_size = 9))

# Year
p_glm_plant_lost_year <- 
  ggplot() +
    geom_point(
      data = df_plant_lost ,
      aes(x = year, y = lost, color = fct_rev(exotic))) +
    geom_smooth(
      data = glm_plant_lost %>% 
        unnest(pred_year),
      aes(x = x, y = predicted, color = fct_rev(exotic)),
      method = "glm", se = FALSE,
      method.args = list(family = "binomial")) +
    labs(
      x = "Years between surveys",
      y = "Probability of species loss"
      ) +
      scale_color_simpsons() +
      theme(
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_text(size = 9),
        legend.position = c(0.25, 0.75),
        legend.background = element_blank(),
        legend.title = element_blank()
        )
  

# Area
p_glm_plant_lost_area <- 
  ggplot() +
    geom_point(
      data = df_plant_lost,
      aes(x = area/10000, y = lost, color = fct_rev(exotic))) +
    geom_smooth(
      data = glm_plant_lost %>% 
        dplyr::filter(exotic == "Native") %>% 
        unnest(pred_area),
      aes(x/10000, predicted, color = fct_rev(exotic)),
      method = "glm", se = FALSE,
      method.args = list(family = "binomial")) +
    labs(
      x = "Area (ha)",
      y = ""
      ) +
    scale_color_simpsons() +
      theme(
        axis.title.y = element_blank(),
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_blank(),
        legend.position = "none"
      )


# Green rate
p_glm_plant_lost_green <- 
  ggplot() +
    geom_point(
      data = df_plant_lost,
      aes(x = green_rate, y = lost, color = fct_rev(exotic))) +
    geom_smooth(
      data = glm_plant_lost %>% 
        unnest(pred_green),
      aes(x, predicted, color = fct_rev(exotic)),
      method = "glm", se = FALSE,
      method.args = list(family = "binomial")) +
      labs(
        x = "Green rate (%)",
        y = ""
      ) +
      scale_color_simpsons() +
      theme(
        axis.title.y = element_blank(),
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_blank(),
        legend.position = "none"
      )



# Combine
p_glm_plant_lost_year + p_glm_plant_lost_area + p_glm_plant_lost_green
```
```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  p_glm_plant_lost_year + p_glm_plant_lost_area + p_glm_plant_lost_green,
  file = "output/plot_glm_plant_lost_env.png",
  width = 170, height = 60, units = "mm", dpi = 500)
```


## Colonized species

Estimate a number of colonized species

```{r}
df_plant_colo <-
  df_plant %>% 
    pivot_wider(names_from = time, values_from = value) %>% 
    dplyr::mutate(colo = if_else(now == 1 & past == 0, 1, 0)) %>% 
    dplyr::left_join(df_trait, by = "species") %>% 
    dplyr::left_join(env, by = "site") %>% 
    dplyr::filter(!is.na(exotic) & now == 1) %>% 
    dplyr::mutate(across(where(is.character), as.factor))
```

Confirmation of number of colonized species across dispersal type
```{r}
df_plant_colo %>% 
  dplyr::group_by(exotic, disper) %>% 
  dplyr::summarise(n = n_distinct(species)) %>% 
  na.omit()
```

### GLM

Relationships between colonized species and trait, environmental variables

```{r}
glm_plant_colo <- 
  df_plant_colo %>% 
    dplyr::mutate(across(where(is.character), as.factor)) %>% 
    group_by(exotic) %>% 
    nest() %>% 
    dplyr::mutate(
      
      # GLM
      fit = map(
        data, 
        ~glm(colo ~ year + area + green_rate + growth + disper, 
             family = "binomial", data = .)),
      
      # summary of GLM
      summary_fit = map(fit, ~tidy(.)),
      
      
      # Growth form
      multi_grow = map(fit, ~glht(., linfct = mcp(growth = "Tukey"))),
      multi_grow_summary = map(multi_grow, ~tidy(.)),
      multi_grow_char = map(multi_grow, ~cld(., decreasing = F)),
      
      
      # Dispersal type
      multi_disper = map(fit, ~glht(., linfct = mcp(disper = "Tukey"))),
      multi_dipser_summary = map(multi_disper, ~tidy(.)),
      multi_disper_char = map(multi_disper, ~cld(., decreasing = F)),
      
      
      # Environment
      pred_year = map(fit, ~ggpredict(., terms = "year")),
      pred_area = map(fit, ~ggpredict(., terms = "area")),
      pred_green = map(fit, ~ggpredict(., terms = "green_rate"))
      ) 
```



Table for result of GLM

```{r}
tb_glm_plant_colo <- 
  glm_plant_colo %>% 
    dplyr::select(exotic, summary_fit) %>% 
    unnest(summary_fit) %>% 
    dplyr::filter(term != "(Intercept)") %>% 
    dplyr::mutate(
      across(where(is.numeric),
             ~ifelse(. > -0.001 & . < 0.001,
                      formatC(., digits = 3, format = "e"),
                      formatC(., digits = 3, format = "fg"))
      )) %>% 
    dplyr::rename(
      Nativity = exotic,
      "Explanatory variables" = term,
      Estimate = estimate,
      Std.error = std.error,
       Statistic = statistic) %>% 
    print()
```
```{r eval=FALSE, include=FALSE}
write.csv(tb_glm_plant_colo, "output/glm_colo_plant.csv")
```


Partial r squared
```{r }

# All species
glm_plant_colo <- 
  glm(colo ~ year + area + green_rate + growth + disper, 
      family = "binomial", data = df_plant_colo)

rsq_glm_plant_lost <- rsq.partial(glm_plant_colo, adj = TRUE)



# Native species
df_plant_colo_native <-
  df_plant_colo %>% 
    dplyr::filter(exotic == "Native" & !is.na(growth) & !is.na(disper)) 

glm_plant_colo_native <- 
  glm(colo ~ year + area + green_rate + growth + disper, 
      family = "binomial", data = df_plant_colo_native)

rsq_glm_plant_colo_native <- rsq.partial(glm_plant_colo_native, adj = TRUE)




# Exotic species
df_plant_colo_exotic <-
  df_plant_colo %>% 
    dplyr::filter(exotic == "Exotic" & !is.na(growth) & !is.na(disper)) 

glm_plant_colo_exotic <- 
  glm(colo ~ year + area + green_rate + growth + disper, 
      family = "binomial", data = df_plant_colo_exotic)

rsq_glm_plant_colo_exotic <- rsq.partial(glm_plant_colo_exotic, adj = TRUE)


df_rsq_glm_plant_colo <- 
  bind_rows(
    rsq_glm_plant_lost[2:3],
    rsq_glm_plant_colo_native[2:3],
    rsq_glm_plant_colo_exotic[2:3]
    ) %>% 
    dplyr::mutate(Nativity = rep(c("All", "Native","Exotic"), each = 5)) %>% 
  print()
```
```{r eval=FALSE, include=FALSE}
write.csv(df_rsq_glm_plant_colo, "output/rsq_glm_plant_colo.csv")
```

### Plot
#### Growth form

Character of result of GLM of growth form

```{r}
cha_glm_plant_colo_growth <-
  bind_rows(
    tidy(glm_plant_colo$multi_grow_char[[1]]),
    tidy(glm_plant_colo$multi_grow_char[[2]])
    ) %>% 
  mutate(
    exotic = fct_inorder(rep(c("Native species","Exotic species"), each = 3)),
    growth = fct_inorder(rep(c("Annual","Perennial","Tree"), 2))
    )
```

Plot for result of glm of growth form

```{r}
box_plant_colo_growth <- 
  df_plant_colo %>% 
    group_by(species, growth, exotic) %>% 
    dplyr::summarise(colo = mean(colo), .groups = "drop") %>% 
    dplyr::filter(!is.na(growth)) %>% 
    dplyr:: mutate(
      exotic = recode_factor(
        exotic,
        "Native" = "Native species",
        "Exotic" = "Exotic species"),
      growth = recode(
        growth,
        "annual" = "Annual",
        "perennial" = "Perennial",
        "tree" = "Tree")
        ) %>% 
  
    # plot
    ggplot() +
    geom_boxplot(aes(x = growth, y = colo, fill = exotic)) + 
    facet_grid(~exotic) +
    geom_text(
      data = cha_glm_plant_colo_growth, 
      aes(x = growth, y = 1.05, label = letters),
      position = position_dodge(width = 1), size = 3) +
    labs(
      x = "Growth form",
      y = "Probability of species colonization",
      fill = "Growth form"
      ) +
    theme_classic(base_size = 8) +
    scale_fill_simpsons() +
    #scale_fill_brewer(palette = "Paired") +
    theme(
      panel.grid = element_blank(),
      legend.position = "none",
      strip.background = element_blank(),
      strip.text = element_text(size = 8)
      )

box_plant_colo_growth
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  box_plant_colo_growth,
  file = "output/box_plant_colo_growth.png",
  width = 100, height = 60, units = "mm", dpi = 500)
```

#### Dispersal type

Character of result of GLM of dispersal type

```{r}
cha_glm_plant_colo_disper <-
  bind_rows(
    tidy(glm_plant_colo$multi_disper_char[[1]]),
    tidy(glm_plant_colo$multi_disper_char[[2]])
    ) %>% 
  mutate(
    exotic = fct_inorder(rep(c("Native species","Exotic species"), each = 4)),
    growth = fct_inorder(rep(c("Animal","Gravity","Water","Wind"), 2))
    )
```

Plot for result of glm of growth form

```{r}
box_plant_colo_disper <- 
  df_plant_colo %>% 
    group_by(species, disper, exotic) %>% 
    dplyr::summarise(colo = mean(colo), .groups = "drop") %>% 
    dplyr::filter(!is.na(disper)) %>% 
    dplyr:: mutate(
      exotic = recode_factor(
        exotic,
        "Native" = "Native species",
        "Exotic" = "Exotic species"),
      disper = recode(
        disper,
        "wind" = "Wind",
        "animal" = "Animal",
        "water" = "Water",
        "gravity" = "Gravity")
        ) %>% 
  
    # plot
    ggplot() +
    geom_boxplot(aes(x = disper, y = colo, fill = exotic)) + 
    facet_grid(~exotic) +
    geom_text(
      data = cha_glm_plant_colo_disper, 
      aes(x = growth, y = 1.05, label = letters),
      position = position_dodge(width = 1), size = 3) +
    labs(
      x = "Dispersal type",
      y = "Probability of species loss"
      ) +
    theme_classic(base_size = 8) +
    scale_fill_simpsons() +
    theme(
      panel.grid = element_blank(),
      legend.position = "none",
      strip.background = element_blank(),
      strip.text = element_text(size = 8)
      )

box_plant_colo_disper
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  box_plant_colo_disper,
  file = "output/box_plant_colo_disper.png",
  width = 100, height = 60, units = "mm", dpi = 500)
```

#### Environment
Plot for the result of GLM of environmental variables
```{r}
theme_set(theme_bw(base_size = 9))

# Year
p_glm_plant_colo_year <- 
  ggplot() +
    geom_point(
      data = df_plant_colo,
      aes(x = year, y = colo, color = fct_rev(exotic))) +
    geom_smooth(
      data = glm_plant_colo %>% 
        unnest(pred_year),
      aes(x = x, y = predicted, color = fct_rev(exotic)),
      method = "glm", se = FALSE,
      method.args = list(family = "binomial")) +
    labs(
      x = "Years between surveys",
      y = "Probability of species colonization"
      ) +
      scale_color_simpsons() +
      theme(
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_text(size = 9),
        legend.position = c(0.25, 0.75),
        legend.background = element_blank(),
        legend.title = element_blank()
        )
  

# Area
p_glm_plant_colo_area <- 
  ggplot() +
    geom_point(
      data = df_plant_colo,
      aes(x = area/10000, y = colo, color = fct_rev(exotic))) +
    geom_smooth(
      data = glm_plant_lost %>% 
        dplyr::filter(exotic == "Native") %>%  
        unnest(pred_area),
      aes(x/10000, predicted, color = fct_rev(exotic)),
      method = "glm", se = FALSE,
      method.args = list(family = "binomial")) +
    labs(
      x = "Area (ha)",
      y = ""
      ) +
    scale_color_simpsons() +
      theme(
        axis.title.y = element_blank(),
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_blank(),
        legend.position = "none"
      )


# Green rate
p_glm_plant_colo_green <- 
  ggplot() +
    geom_point(
      data = df_plant_colo,
      aes(x = green_rate, y = colo, color = fct_rev(exotic))) +
    geom_smooth(
      data = glm_plant_colo %>% 
        dplyr::filter(exotic == "Native") %>% 
        unnest(pred_green),
      aes(x, predicted, color = fct_rev(exotic)),
      method = "glm", se = FALSE,
      method.args = list(family = "binomial")) +
      labs(
        x = "Green rate (%)",
        y = ""
      ) +
      scale_color_simpsons() +
      theme(
        axis.title.y = element_blank(),
        strip.placement = "outside",
        strip.background = element_blank(),
        strip.text = element_blank(),
        legend.position = "none"
      )



# Combine
p_glm_plant_colo_year + p_glm_plant_colo_area + p_glm_plant_colo_green
```
```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  p_glm_plant_colo_year + p_glm_plant_colo_area + p_glm_plant_colo_green,
  file = "output/plot_glm_plant_colo_env.png",
  width = 170, height = 60, units = "mm", dpi = 500)
```



# Species composition

```{r}
comp_plant <- 
  df_plant_trait %>% 
  dplyr::select(site:value, exotic) %>% 
  dplyr::filter(!is.na(exotic)) %>% 
  pivot_wider(names_from = species, values_from = value, values_fill = 0) %>% 
  nest_by(exotic) %>%  
  ungroup() %>% 
  dplyr::mutate(
    comp = map(data, 
               ~dplyr::select(., where(~ is.numeric(.) && sum(.) != 0))),
    
    # NMDS
    nmds = map(comp, 
               ~metaMDS(., dist = "jac", k = 2, trace = F, trymax = 999)),
    
    # NMDS axis score
    nmds_score = map(nmds, ~scores(.) %>% pluck(1) %>% as.data.frame()),
    
    # NMDS stress value
    nmds_stress = map_dbl(nmds, ~.$stress),
    
    # permanova
    permanova = map(data, ~adonis2(.[,-1:-2] ~ .$time, method = "jac")),
    
    
    # p-value from permanova
    pval = map(permanova, ~as.tibble(.) %>% dplyr::select("Pr(>F)")),
    
    
    exotic = recode_factor(exotic, 
                           "Native" = "Native species",
                           "Exotic" = "Exotic species")
    ) %>% 
  print()
```

## Permanova

```{r}
df_label_plant <-
  comp_plant %>% 
    dplyr::select(exotic, nmds_stress, pval) %>% 
    unnest(pval) %>% 
    na.omit() %>% 
    dplyr::mutate(
      across(where(is.numeric), ~round(., digits = 3)),
      time = "Past",
      stressvalue = "Stress value:",
      permanova_cha = "Permanova: p = "
      ) %>% 
    unite(stress, stressvalue, nmds_stress, remove = F, sep = "") %>% 
    unite(permanova, permanova_cha, "Pr(>F)", remove = F, sep = "") %>% 
    print()
```

Plot for result of nmds

```{r}
p_nmds_plant <- 
  comp_plant %>% 
  dplyr::select(exotic, nmds_score) %>% 
  unnest(nmds_score) %>% 
  mutate(
    time = rep(c("Past", "Present"), 30),
    time = factor(time, levels = c("Past", "Present"))) %>% 
  
    ggplot(aes(x = NMDS1, y = NMDS2, color = time)) +
      geom_point() +
      stat_ellipse(
        aes(group = time, fill = time), 
        alpha = 0.1,
        geom = "polygon") +
      facet_wrap(.~exotic) +
      
  
      # Stress value
      geom_text(
        data = df_label_plant, aes(label = stress), 
        x = 0.85, y = 1.2, size = 2, color = "grey50", hjust = 0) +
      
      # P value from Permanova
      geom_text(
        data = df_label_plant, aes(label = permanova), 
        x = 0.85, y = 1.1, size = 2, color = "grey50", hjust = 0) +
  
      theme_bw(base_size = 9) +
      theme(
        panel.grid = element_blank(),
        legend.position = c(0.08, 0.9),
        legend.title = element_blank(),
        legend.background = element_blank(),
        strip.background = element_blank()
        )

p_nmds_plant
```

```{r eval=FALSE, include=FALSE}
# For save
ggsave(
  p_nmds_plant,
  file = "output/plot_nmds_plant.png",
  width = 170, height = 90, units = "mm", dpi = 500)
```
